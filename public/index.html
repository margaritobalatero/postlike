<!DOCTYPE html>
<html>
<head>
  <title>Junjie Posts</title>

  <!-- Bootstrap CSS -->
  <link
    href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css"
    rel="stylesheet"
  >

  <!-- Quill CSS -->
  <link
    href="https://cdn.quilljs.com/1.3.7/quill.snow.css"
    rel="stylesheet"
  >

  <style>
    #editor {
      height: 200px;
      background-color: #fff;
    }
  </style>
</head>

<body class="bg-light p-3">

  <div class="container">

    <!-- POSTS -->
    <div id="posts"></div>

    <!-- ADD POST -->
    <form id="postForm" class="mb-3 mt-3">
      <input
        type="text"
        id="title"
        class="form-control mb-2"
        placeholder="Title"
        required
      >

      <div id="editor"></div>

      <button
        type="submit"
        id="postBtn"
        class="btn btn-primary mt-2"
      >
        Add Post
      </button>
    </form>

    <br>

    <!-- BOTTOM BUTTONS -->
    <div class="d-flex justify-content-start mb-4">
      <button id="loginBtn" class="btn btn-success me-2">
        Login with MetaMask
      </button>

      <button id="logoutBtn" class="btn btn-danger" disabled>
        Logout
      </button>
    </div>

  </div>

  <!-- Quill JS -->
  <script src="https://cdn.quilljs.com/1.3.7/quill.min.js"></script>

  <script type="module">
    let session_name = "guest";

    const loginBtn = document.getElementById("loginBtn");
    const logoutBtn = document.getElementById("logoutBtn");
    const postBtn = document.getElementById("postBtn");
    const titleInput = document.getElementById("title");
    const postForm = document.getElementById("postForm");

    const quill = new Quill("#editor", {
      theme: "snow",
      placeholder: "Write your post here..."
    });

    function updateUI() {
      const isGuest = session_name === "guest";
      postForm.style.display = isGuest ? "none" : "block";
      postBtn.disabled = isGuest;
      loginBtn.disabled = !isGuest;
      logoutBtn.disabled = isGuest;
    }

    async function loadPosts() {
      const res = await fetch("/api/posts", { credentials: "include" });
      const data = await res.json();

      session_name = data.session_name;
      updateUI();

      const container = document.getElementById("posts");
      container.innerHTML = "";

      data.posts.forEach(post => {
        const commentsHtml = post.comments
          .map(c => `<p><b>${c.author}</b>: ${c.text}</p>`)
          .join("");

        const div = document.createElement("div");
        div.className = "card mb-3 p-3";

        div.innerHTML = `
          <h3>${post.title}
            <small class="text-muted">by ${post.author}</small>
          </h3>

          <div>${post.content}</div>

          <p class="mt-2">üëç ${post.likes} | üëé ${post.dislikes}</p>

          ${
            session_name !== "guest"
              ? `
                <button class="btn btn-outline-primary btn-sm me-1"
                  onclick="likePost('${post._id}')">
                  ${post.is_liked ? "Unlike" : "Like"}
                </button>

                <button class="btn btn-outline-secondary btn-sm me-1"
                  onclick="dislikePost('${post._id}')">
                  ${post.is_disliked ? "Undislike" : "Dislike"}
                </button>
              `
              : ""
          }

          <div class="mt-3">
            <h5>Comments</h5>
            ${commentsHtml}

            ${
              session_name !== "guest"
                ? `
                  <textarea
                    id="comment-${post._id}"
                    class="form-control mb-1"
                    placeholder="Write a comment"
                  ></textarea>

                  <button class="btn btn-secondary btn-sm"
                    onclick="addComment('${post._id}')">
                    Comment
                  </button>
                `
                : "<i>Login to comment</i>"
            }
          </div>

          ${
            post.author === session_name
              ? `
                <button class="btn btn-outline-danger btn-sm mt-2"
                  onclick="deletePost('${post._id}')">
                  Delete
                </button>
              `
              : ""
          }
        `;

        container.appendChild(div);
      });
    }

    window.addComment = async id => {
      const textarea = document.getElementById(`comment-${id}`);
      if (!textarea.value.trim()) return;

      await fetch(`/api/posts/comment/${id}`, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        credentials: "include",
        body: JSON.stringify({ text: textarea.value })
      });

      textarea.value = "";
      loadPosts();
    };

    window.likePost = async id => {
      await fetch(`/api/posts/like/${id}`, {
        method: "POST",
        credentials: "include"
      });
      loadPosts();
    };

    window.dislikePost = async id => {
      await fetch(`/api/posts/dislike/${id}`, {
        method: "POST",
        credentials: "include"
      });
      loadPosts();
    };

    window.deletePost = async id => {
      await fetch(`/api/posts/delete/${id}`, {
        method: "DELETE",
        credentials: "include"
      });
      loadPosts();
    };

    postForm.onsubmit = async e => {
      e.preventDefault();

      const content = quill.root.innerHTML.trim();
      if (!content || content === "<p><br></p>") return;

      await fetch("/api/posts", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        credentials: "include",
        body: JSON.stringify({
          title: titleInput.value,
          content
        })
      });

      titleInput.value = "";
      quill.root.innerHTML = "";
      loadPosts();
    };

    loginBtn.onclick = async () => {
      const [address] = await ethereum.request({
        method: "eth_requestAccounts"
      });

      const nonceRes = await fetch(`/auth/nonce?address=${address}`, {
        credentials: "include"
      });

      const { nonce } = await nonceRes.json();

      const signature = await ethereum.request({
        method: "personal_sign",
        params: [`Login nonce: ${nonce}`, address]
      });

      const res = await fetch("/auth/login", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        credentials: "include",
        body: JSON.stringify({ address, signature })
      });

      const data = await res.json();
      if (data.success) {
        session_name = data.address;
        updateUI();
        loadPosts();
      }
    };

    logoutBtn.onclick = async () => {
      await fetch("/auth/logout", {
        method: "POST",
        credentials: "include"
      });

      session_name = "guest";
      updateUI();
      loadPosts();
    };

    loadPosts();
  </script>
</body>
</html>
