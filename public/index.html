<!DOCTYPE html>
<html>
<head>
  <title>Posts</title>

  <!-- Bootstrap CSS CDN -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">

  <style>
    .editor {
      border: 1px solid #ced4da;
      border-radius: 5px;
      min-height: 150px;
      padding: 10px;
      background: white;
    }
    .editor:focus {
      outline: none;
      border-color: #0d6efd;
    }
  </style>
</head>

<body class="bg-light p-3">
  <div class="container">

    <!-- POSTS -->
    <div id="posts"></div>

    <!-- ADD POST -->
    <form id="postForm" class="mb-3 mt-3">
      <input type="text" id="title" class="form-control mb-2" placeholder="Title" required />

      <!-- Toolbar -->
      <div class="mb-2">
        <button type="button" class="btn btn-sm btn-secondary" onclick="format('bold')"><b>B</b></button>
        <button type="button" class="btn btn-sm btn-secondary" onclick="format('italic')"><i>I</i></button>
        <button type="button" class="btn btn-sm btn-secondary" onclick="addLink()">Link</button>
        <button type="button" class="btn btn-sm btn-secondary" onclick="addImage()">Image</button>
        <button type="button" class="btn btn-sm btn-secondary" onclick="addVideo()">Video</button>
      </div>

      <!-- Editor -->
      <div id="content" class="editor" contenteditable="true"></div>

      <button type="submit" id="postBtn" class="btn btn-primary mt-2">Add Post</button>
    </form>

    <!-- AUTH BUTTONS -->
    <div class="d-flex justify-content-start mb-4">
      <button id="loginBtn" class="btn btn-success me-2">Login with MetaMask</button>
      <button id="logoutBtn" class="btn btn-danger" disabled>Logout</button>
    </div>
  </div>

<script type="module">
  let session_name = "guest";

  const loginBtn = document.getElementById("loginBtn");
  const logoutBtn = document.getElementById("logoutBtn");
  const postBtn = document.getElementById("postBtn");
  const postForm = document.getElementById("postForm");
  const titleInput = document.getElementById("title");
  const contentDiv = document.getElementById("content");

  function updateUI() {
    const isGuest = session_name === "guest";
    postForm.style.display = isGuest ? "none" : "block";
    postBtn.disabled = isGuest;
    loginBtn.disabled = !isGuest;
    logoutBtn.disabled = isGuest;
  }

  /* ===== EDITOR FUNCTIONS ===== */
  window.format = cmd => document.execCommand(cmd);

  window.addLink = () => {
    const url = prompt("Enter link URL");
    if (url) document.execCommand("createLink", false, url);
  };

  window.addImage = () => {
    const url = prompt("Enter image URL");
    if (url) document.execCommand("insertImage", false, url);
  };

  window.addVideo = () => {
    const url = prompt("Enter YouTube or MP4 URL");
    if (!url) return;

    let embed = "";

    if (url.includes("youtube.com") || url.includes("youtu.be")) {
      const id = url.split("v=")[1] || url.split("/").pop();
      embed = `<iframe width="100%" height="315"
        src="https://www.youtube.com/embed/${id}"
        frameborder="0" allowfullscreen></iframe>`;
    } else {
      embed = `<video controls width="100%">
        <source src="${url}">
      </video>`;
    }

    contentDiv.innerHTML += embed;
  };

  /* ===== LOAD POSTS ===== */
  async function loadPosts() {
    const res = await fetch("/api/posts", { credentials: "include" });
    const data = await res.json();
    session_name = data.session_name;
    updateUI();

    const container = document.getElementById("posts");
    container.innerHTML = "";

    data.posts.forEach(post => {
      const div = document.createElement("div");
      div.className = "card mb-3 p-3";
      div.innerHTML = `
        <h4>${post.title} <small class="text-muted">by ${post.author}</small></h4>
        <div>${post.content}</div>
        <hr/>
      `;
      container.appendChild(div);
    });
  }

  /* ===== SUBMIT POST ===== */
  postForm.onsubmit = async e => {
    e.preventDefault();

    await fetch("/api/posts", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      credentials: "include",
      body: JSON.stringify({
        title: titleInput.value,
        content: contentDiv.innerHTML
      })
    });

    titleInput.value = "";
    contentDiv.innerHTML = "";
    loadPosts();
  };

  /* ===== AUTH ===== */
  loginBtn.onclick = async () => {
    const [address] = await ethereum.request({ method: "eth_requestAccounts" });
    const nonceRes = await fetch(`/auth/nonce?address=${address}`, { credentials: "include" });
    const { nonce } = await nonceRes.json();

    const signature = await ethereum.request({
      method: "personal_sign",
      params: [`Login nonce: ${nonce}`, address]
    });

    const res = await fetch("/auth/login", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      credentials: "include",
      body: JSON.stringify({ address, signature })
    });

    const data = await res.json();
    if (data.success) {
      session_name = data.address;
      updateUI();
      loadPosts();
    }
  };

  logoutBtn.onclick = async () => {
    await fetch("/auth/logout", { method: "POST", credentials: "include" });
    session_name = "guest";
    updateUI();
    loadPosts();
  };

  loadPosts();
</script>
</body>
</html>
