<!DOCTYPE html>
<html data-bs-theme="light">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Junjie Posts</title>

  <link
    href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css"
    rel="stylesheet"
    integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH"
    crossorigin="anonymous"
  >

  <style>
    [data-bs-theme="dark"] {
      --bs-body-bg: #0d1117;
      --bs-body-color: #e6edf3;
      --bs-secondary-color: #8b949e;
      --bs-border-color: #30363d;

      .card {
        background-color: #161b22;
        border-color: #30363d;
      }

      .text-muted {
        --bs-text-opacity: 0.65;
      }

      .form-control {
        background-color: #0d1117;
        border-color: #30363d;
        color: #e6edf3;
      }

      .form-control::placeholder {
        color: #8b949e;
      }

      .btn-outline-primary {
        --bs-btn-color: #58a6ff;
        --bs-btn-border-color: #388bfd;
        --bs-btn-hover-color: #ffffff;
        --bs-btn-hover-bg: #388bfd;
      }
    }

    html {
      transition: background-color 0.3s, color 0.3s;
    }

    .post-card {
      transition: all 0.2s;
    }
  </style>
</head>

<body class="p-3">

  <div class="container">

    <!-- Theme + Auth row -->
    <div class="d-flex justify-content-between align-items-center mb-4 flex-wrap gap-3">
      <button id="themeToggle" class="btn btn-outline-secondary btn-sm">
        üåô Dark Mode
      </button>

      <div class="d-flex gap-2">
        <button id="loginBtn" class="btn btn-success">
          Login with MetaMask
        </button>
        <button id="logoutBtn" class="btn btn-danger" disabled>
          Logout
        </button>
      </div>
    </div>

    <!-- Add post form -->
    <form id="postForm" class="mb-4">
      <input
        type="text"
        id="title"
        placeholder="Title"
        class="form-control mb-2"
        required
      >
      <textarea
        id="content"
        placeholder="Content..."
        class="form-control mb-2"
        rows="5"
        required
      ></textarea>
      <button type="submit" id="postBtn" class="btn btn-primary">
        Add Post
      </button>
    </form>

    <!-- Posts container -->
    <div id="posts" class="d-flex flex-column gap-3"></div>

  </div>

  <script type="module">
    let session_name = "guest";

    const htmlEl         = document.documentElement;
    const themeToggle    = document.getElementById("themeToggle");
    const loginBtn       = document.getElementById("loginBtn");
    const logoutBtn      = document.getElementById("logoutBtn");
    const postBtn        = document.getElementById("postBtn");
    const titleInput     = document.getElementById("title");
    const contentInput   = document.getElementById("content");
    const postForm       = document.getElementById("postForm");
    const postsContainer = document.getElementById("posts");

    // ‚îÄ‚îÄ Theme handling ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    function setTheme(theme) {
      htmlEl.setAttribute("data-bs-theme", theme);
      themeToggle.textContent = theme === "dark" ? "‚òÄÔ∏è Light Mode" : "üåô Dark Mode";
      localStorage.setItem("theme", theme);
    }

    const savedTheme = localStorage.getItem("theme");
    if (savedTheme) {
      setTheme(savedTheme);
    } else if (window.matchMedia("(prefers-color-scheme: dark)").matches) {
      setTheme("dark");
    }

    themeToggle.onclick = () => {
      const current = htmlEl.getAttribute("data-bs-theme") || "light";
      setTheme(current === "dark" ? "light" : "dark");
    };

    // ‚îÄ‚îÄ UI update ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    function updateUI() {
      const isGuest = session_name === "guest";
      postForm.style.display = isGuest ? "none" : "block";
      postBtn.disabled = isGuest;
      loginBtn.disabled = !isGuest;
      logoutBtn.disabled = isGuest;
    }

    // ‚îÄ‚îÄ Load & render posts ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    async function loadPosts() {
      try {
        const res = await fetch("/api/posts", { credentials: "include" });
        if (!res.ok) throw new Error("Failed to load posts");
        const data = await res.json();

        session_name = data.session_name;
        updateUI();

        postsContainer.innerHTML = "";

        data.posts.forEach(post => {
          const commentsHtml = post.comments
            .map(c => `<p class="mb-1"><strong>${c.author}</strong>: ${c.text}</p>`)
            .join("") || '<p class="text-muted fst-italic small">No comments yet.</p>';

          const card = document.createElement("div");
          card.className = "card post-card shadow-sm";

          card.innerHTML = `
            <div class="card-body">
              <h5 class="card-title mb-1">
                ${post.title}
                <small class="text-muted"> ‚Ä¢ by ${post.author}</small>
              </h5>
              <p class="card-text mb-2">${post.content}</p>

              <div class="text-muted small mb-3">
                üëç ${post.likes}   ‚Ä¢   üëé ${post.dislikes}
              </div>

              ${session_name !== "guest" ? `
                <button class="btn btn-outline-primary btn-sm me-2 mb-2"
                        onclick="likePost('${post._id}')">
                  ${post.is_liked ? "Unlike" : "Like"}
                </button>
                <button class="btn btn-outline-secondary btn-sm me-2 mb-2"
                        onclick="dislikePost('${post._id}')">
                  ${post.is_disliked ? "Undislike" : "Dislike"}
                </button>
              ` : ""}

              <div class="mt-3">
                <h6 class="mb-2">Comments</h6>
                ${commentsHtml}

                ${session_name !== "guest" ? `
                  <textarea id="comment-${post._id}"
                    class="form-control form-control-sm mt-2 mb-2"
                    placeholder="Write a comment..."
                    rows="2"></textarea>
                  <button class="btn btn-secondary btn-sm"
                          onclick="addComment('${post._id}')">
                    Comment
                  </button>
                ` : "<small class=\"text-muted\">Login to comment</small>"}
              </div>

              ${post.author === session_name ? `
                <button class="btn btn-outline-danger btn-sm mt-3"
                        onclick="deletePost('${post._id}')">
                  Delete
                </button>
              ` : ""}
            </div>
          `;

          postsContainer.appendChild(card);
        });
      } catch (err) {
        console.error(err);
        postsContainer.innerHTML = `<div class="alert alert-danger">Failed to load posts. Please try again.</div>`;
      }
    }

    // ‚îÄ‚îÄ MetaMask login with better error handling ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    loginBtn.onclick = async () => {
      if (typeof window.ethereum === "undefined") {
        alert(
          "MetaMask not detected!\n\n" +
          "Please check:\n" +
          "1. MetaMask extension is installed and unlocked\n" +
          "2. You are visiting the site over HTTPS (not HTTP)\n" +
          "3. Refresh the page\n" +
          "4. Try in Chrome/Brave/Firefox (not in-app browser)"
        );
        return;
      }

      try {
        const [address] = await window.ethereum.request({
          method: "eth_requestAccounts"
        });

        const nonceRes = await fetch(`/auth/nonce?address=${address}`, {
          credentials: "include"
        });
        const { nonce } = await nonceRes.json();

        const signature = await window.ethereum.request({
          method: "personal_sign",
          params: [`Login nonce: ${nonce}`, address]
        });

        const res = await fetch("/auth/login", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          credentials: "include",
          body: JSON.stringify({ address, signature })
        });

        const data = await res.json();
        if (data.success) {
          session_name = data.address;
          updateUI();
          loadPosts();
        } else {
          alert("Login failed: " + (data.error || "Unknown error"));
        }
      } catch (err) {
        console.error("MetaMask login error:", err);
        let msg = "Login failed.";
        if (err.code === 4001) msg = "You rejected the connection.";
        else if (err.code === -32002) msg = "MetaMask is busy ‚Äî check the extension.";
        else if (err.message) msg += " " + err.message;
        alert(msg);
      }
    };

    logoutBtn.onclick = async () => {
      await fetch("/auth/logout", {
        method: "POST",
        credentials: "include"
      });
      session_name = "guest";
      updateUI();
      loadPosts();
    };

    // ‚îÄ‚îÄ Form submit ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    postForm.onsubmit = async e => {
      e.preventDefault();
      await fetch("/api/posts", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        credentials: "include",
        body: JSON.stringify({
          title: titleInput.value.trim(),
          content: contentInput.value.trim()
        })
      });
      titleInput.value = "";
      contentInput.value = "";
      loadPosts();
    };

    // ‚îÄ‚îÄ Global helper functions ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    window.addComment = async (postId) => {
      const textarea = document.getElementById(`comment-${postId}`);
      const text = textarea.value.trim();
      if (!text) return;

      await fetch(`/api/posts/comment/${postId}`, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        credentials: "include",
        body: JSON.stringify({ text })
      });

      textarea.value = "";
      loadPosts();
    };

    window.likePost = async (id) => {
      await fetch(`/api/posts/like/${id}`, {
        method: "POST",
        credentials: "include"
      });
      loadPosts();
    };

    window.dislikePost = async (id) => {
      await fetch(`/api/posts/dislike/${id}`, {
        method: "POST",
        credentials: "include"
      });
      loadPosts();
    };

    window.deletePost = async (id) => {
      if (!confirm("Delete this post?")) return;
      await fetch(`/api/posts/delete/${id}`, {
        method: "DELETE",
        credentials: "include"
      });
      loadPosts();
    };

    // Initial load
    loadPosts();
  </script>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
