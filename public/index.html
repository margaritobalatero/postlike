<!DOCTYPE html>
<html data-bs-theme="light">   <!-- start with light; will be toggled -->
<head>
  <title>Junjie Posts</title>

  <!-- Bootstrap 5.3+ CSS (already supports data-bs-theme) -->
  <link
    href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css"
    rel="stylesheet"
    integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH"
    crossorigin="anonymous"
  >

  <style>
    /* Optional: small fixes/improvements for better dark mode look */
    [data-bs-theme="dark"] {
      --bs-body-bg: #0d1117;           /* GitHub-like dark bg */
      --bs-body-color: #e6edf3;        /* light text */
      --bs-secondary-color: #8b949e;
      --bs-border-color: #30363d;

      /* Make cards stand out a bit more */
      .card {
        background-color: #161b22;
        border-color: #30363d;
      }

      /* Slightly better muted text */
      .text-muted {
        --bs-text-opacity: 0.65;
      }

      /* Form controls look better */
      .form-control {
        background-color: #0d1117;
        border-color: #30363d;
        color: #e6edf3;
      }

      .form-control::placeholder {
        color: #8b949e;
      }

      /* Buttons that aren't primary/secondary look nicer */
      .btn-outline-primary {
        --bs-btn-color: #58a6ff;
        --bs-btn-border-color: #388bfd;
        --bs-btn-hover-color: #ffffff;
        --bs-btn-hover-bg: #388bfd;
      }
    }

    /* Smooth transition when switching themes */
    html {
      transition: background-color 0.25s, color 0.25s;
    }
  </style>
</head>

<body class="p-3">

  <div class="container">

    <!-- Theme toggle + Auth buttons -->
    <div class="d-flex justify-content-between align-items-center mb-4">
      <div>
        <button id="themeToggle" class="btn btn-outline-secondary btn-sm">
          üåô Dark Mode
        </button>
      </div>

      <div class="d-flex justify-content-start">
        <button id="loginBtn" class="btn btn-success me-2">
          Login with MetaMask
        </button>
        <button id="logoutBtn" class="btn btn-danger" disabled>
          Logout
        </button>
      </div>
    </div>

    <!-- ADD POST FORM -->
    <form id="postForm" class="mb-4">
      <input
        type="text"
        id="title"
        placeholder="Title"
        class="form-control mb-2"
        required
      >
      <textarea
        id="content"
        placeholder="Content"
        class="form-control mb-2"
        rows="5"
        required
      ></textarea>
      <button type="submit" id="postBtn" class="btn btn-primary">
        Add Post
      </button>
    </form>

    <!-- POSTS -->
    <div id="posts" class="row row-cols-1 g-3"></div>

  </div>

  <script type="module">
    let session_name = "guest";

    const htmlEl       = document.documentElement;
    const themeToggle  = document.getElementById("themeToggle");
    const loginBtn     = document.getElementById("loginBtn");
    const logoutBtn    = document.getElementById("logoutBtn");
    const postBtn      = document.getElementById("postBtn");
    const titleInput   = document.getElementById("title");
    const contentInput = document.getElementById("content");
    const postForm     = document.getElementById("postForm");

    // ‚îÄ‚îÄ Theme logic ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    function setTheme(theme) {
      htmlEl.setAttribute("data-bs-theme", theme);
      themeToggle.textContent = theme === "dark" ? "‚òÄÔ∏è Light Mode" : "üåô Dark Mode";
      localStorage.setItem("theme", theme);
    }

    // Load saved theme or system preference
    const savedTheme = localStorage.getItem("theme");
    if (savedTheme) {
      setTheme(savedTheme);
    } else if (window.matchMedia("(prefers-color-scheme: dark)").matches) {
      setTheme("dark");
    }

    themeToggle.onclick = () => {
      const current = htmlEl.getAttribute("data-bs-theme") || "light";
      setTheme(current === "dark" ? "light" : "dark");
    };

    // ‚îÄ‚îÄ Rest of your existing logic (slightly cleaned up) ‚îÄ‚îÄ
    function updateUI() {
      const isGuest = session_name === "guest";
      postForm.style.display = isGuest ? "none" : "block";
      postBtn.disabled = isGuest;
      loginBtn.disabled = !isGuest;
      logoutBtn.disabled = isGuest;
    }

    async function loadPosts() {
      const res = await fetch("/api/posts", { credentials: "include" });
      if (!res.ok) return;
      const data = await res.json();

      session_name = data.session_name;
      updateUI();

      const container = document.getElementById("posts");
      container.innerHTML = "";

      data.posts.forEach(post => {
        const commentsHtml = post.comments
          .map(c => `<p class="mb-1"><b>${c.author}</b>: ${c.text}</p>`)
          .join("");

        const card = document.createElement("div");
        card.className = "card";

        card.innerHTML = `
          <div class="card-body">
            <h5 class="card-title">
              ${post.title}
              <small class="text-muted">by ${post.author}</small>
            </h5>
            <p class="card-text">${post.content}</p>

            <p class="text-muted mb-2">
              üëç ${post.likes}  ‚Ä¢  üëé ${post.dislikes}
            </p>

            ${session_name !== "guest" ? `
              <button class="btn btn-outline-primary btn-sm me-2"
                onclick="likePost('${post._id}')">
                ${post.is_liked ? "Unlike" : "Like"}
              </button>
              <button class="btn btn-outline-secondary btn-sm me-2"
                onclick="dislikePost('${post._id}')">
                ${post.is_disliked ? "Undislike" : "Dislike"}
              </button>
            ` : ""}

            <div class="mt-3">
              <h6 class="mb-2">Comments</h6>
              ${commentsHtml || '<p class="text-muted fst-italic">No comments yet</p>'}

              ${session_name !== "guest" ? `
                <textarea id="comment-${post._id}"
                  class="form-control form-control-sm mt-2 mb-2"
                  placeholder="Write a comment..."
                  rows="2"></textarea>
                <button class="btn btn-secondary btn-sm"
                  onclick="addComment('${post._id}')">
                  Comment
                </button>
              ` : "<small class=\"text-muted\">Login to comment</small>"}
            </div>

            ${post.author === session_name ? `
              <button class="btn btn-outline-danger btn-sm mt-3"
                onclick="deletePost('${post._id}')">
                Delete
              </button>
            ` : ""}
          </div>
        `;

        container.appendChild(card);
      });
    }

    // Your existing window functions (unchanged)
    window.addComment = async postId => {
      const textarea = document.getElementById(`comment-${postId}`);
      const text = textarea.value.trim();
      if (!text) return;

      await fetch(`/api/posts/comment/${postId}`, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        credentials: "include",
        body: JSON.stringify({ text })
      });

      textarea.value = "";
      loadPosts();
    };

    window.likePost = async id => {
      await fetch(`/api/posts/like/${id}`, { method: "POST", credentials: "include" });
      loadPosts();
    };

    window.dislikePost = async id => {
      await fetch(`/api/posts/dislike/${id}`, { method: "POST", credentials: "include" });
      loadPosts();
    };

    window.deletePost = async id => {
      await fetch(`/api/posts/delete/${id}`, { method: "DELETE", credentials: "include" });
      loadPosts();
    };

    postForm.onsubmit = async e => {
      e.preventDefault();
      await fetch("/api/posts", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        credentials: "include",
        body: JSON.stringify({
          title: titleInput.value,
          content: contentInput.value
        })
      });
      titleInput.value = "";
      contentInput.value = "";
      loadPosts();
    };

    // Login / Logout (unchanged)
    loginBtn.onclick = async () => {
      try {
        const [address] = await ethereum.request({ method: "eth_requestAccounts" });
        const nonceRes = await fetch(`/auth/nonce?address=${address}`, { credentials: "include" });
        const { nonce } = await nonceRes.json();

        const signature = await ethereum.request({
          method: "personal_sign",
          params: [`Login nonce: ${nonce}`, address]
        });

        const res = await fetch("/auth/login", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          credentials: "include",
          body: JSON.stringify({ address, signature })
        });

        const data = await res.json();
        if (data.success) {
          session_name = data.address;
          updateUI();
          loadPosts();
        }
      } catch (err) {
        console.error("Login failed", err);
      }
    };

    logoutBtn.onclick = async () => {
      await fetch("/auth/logout", { method: "POST", credentials: "include" });
      session_name = "guest";
      updateUI();
      loadPosts();
    };

    // Initial load
    loadPosts();
  </script>

  <!-- Bootstrap JS (needed for any interactive components, though not strictly required here) -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
